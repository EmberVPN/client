name: CI/CD

on:
  push:
    branches: '*'

jobs:

  version:
    name: Bump Version
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}
      - run: |
          git config --global user.name 'CI/CD'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          npm version patch -m "Bump: %s"
      - run: git push

  build-win:
    name: Build (Windows)
    runs-on: windows-latest
    if: github.ref == 'refs/heads/stable'

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install Dependencies
        run: npm ci

      - name: "Build for Windows"
        run: npm run build:win

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v3
        with:
          name: windows
          path: dist/*.exe
  
  build-linux:
    name: Build (Linux)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/stable'

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install Dependencies
        run: npm ci

      - name: "Build for Linux"
        run: npm run build:linux

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v3
        with:
          name: linux
          path: |
            dist/*.deb
            dist/*.snap
  
  build-mac:
    name: Build (MacOS)
    runs-on: macos-latest
    if: github.ref == 'refs/heads/stable'

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      - name: Use Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Install Dependencies
        run: npm ci

      - name: "Build for MacOS"
        run: npm run build:mac

      - name: "Upload Artifact"
        uses: actions/upload-artifact@v3
        with:
          name: mac
          path: dist/*.dmg

#   create-release:
#     name: Create Release
#     runs-on: ubuntu-latest
#     if: github.ref == 'refs/heads/stable'
#     needs: [build-win, build-linux, build-mac]

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v3
#         with:
#           ref: ${{ github.ref }}

#       - name: "Download Artifact (Windows)"
#         uses: actions/download-artifact@v3
#         with:
#           name: windows
#           path: dist
#       - name: "Download Artifact (Linux)"
#         uses: actions/download-artifact@v3
#         with:
#           name: linux
#           path: dist
#       - name: "Download Artifact (MacOS)"
#         uses: actions/download-artifact@v3
#         with:
#           name: mac
#           path: dist

#       - name: Read Version
#         uses: dutscher/read-package-json-endpoint-actions@v1.33.7
#         id: version

#       - name: "Create Release"
#         uses: softprops/action-gh-release@v1
#         with:
#           files: |
#             dist/*.exe
#             dist/*.deb
#             dist/*.snap
#             dist/*.dmg
#           draft: true
#           prerelease: true
#           tag_name: v${{ steps.version.outputs.endpoint }}
#           name: v${{ steps.version.outputs.endpoint }}
#           token: ${{ secrets.GITHUB_TOKEN }}
